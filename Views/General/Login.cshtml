@{
    ViewBag.Title = "Iniciar Sesión";
}

<link rel="stylesheet" href="@Url.Content("~/Estilos/estilos.css")">

<div class="contenedor">
    <div class="cont">
        <h2 class="titulo">Iniciar Sesión</h2>
        
        <form id="loginForm">
            <label for="numeroIdentidad">Número de Identidad:</label><br />
            <input type="text" id="documento" name="num_ident" required pattern="\d+" title="Solo se permiten números" /><br />

            <label for="contraseña">Contraseña:</label><br />
            <input type="password" id="contraseña" name="contras_usu" required /><br />
            <div class="cajaEnlace">
                <button type="button" onclick="solicitarCambioContrasena()" class="botonOlv">¿Olvidaste tu contraseña?</button>
            </div>
            <div class="cajaBoton">
                <button type="submit" class="botonForm">Ingresar</button>
            </div>
            <div class="cajaEnlace arriba">
                <a href="@Url.Action("RegistroCliente", "General")" class="enlace enlaceReg">Registrar</a>
            </div>

        </form>

        <!-- Aquí se mostrarán los errores -->
        <div id="errorMessage" style="color: red; text-align: center; margin-top: 10px;"></div>

    </div>

    <img class="imagenFondo" src="~/Imagenes/login.jpg" alt="">

    @* El mensaje de cambio de contraseña se muestra solo si TempData lo trae *@
    @if (TempData["CambioContrasena"] != null && (bool)TempData["CambioContrasena"] == true)
    {
        <div id="mensajeCambioContrasena" class="mensaje">
            <h2>Es necesario actualizar tu contraseña</h2>
            <p>Serás redirigido en unos segundos...</p>
        </div>
    }
</div>
<!-- Restringir la entrada de caracteres, permitiendo solo numeros -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const input = document.getElementById('documento');
        if (input) {
            input.addEventListener('input', function () {
                this.value = this.value.replace(/\D/g, '');
            });
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Mostra mensaje de envio de correo para recuperación de contraseña -->

<script>
       function solicitarCambioContrasena() {
        let numIdentidad = document.getElementById("documento").value; // Obtiene el número de identidad

        if (!numIdentidad) {
            Swal.fire({
                title: "Error",
                text: "Ingresa tu número de identidad antes de solicitar la recuperación.",
                icon: "error",
                customClass: {
                    popup: 'swal2-popup',
                    title: 'swal2-title',
                    content: 'swal2-content',
                    confirmButton: 'boton'
                }
            });
            return;
        }

        fetch("@Url.Action("OlvideContrasena", "General")", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ num_ident: numIdentidad }) // Envía el número de identidad al backend
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    title: "Correo enviado 📩",
                    text: "A tu correo fue enviado un mensaje para restablecer tu contraseña.",
                    icon: "success",
                    customClass: {
                        popup: 'swal2-popup',
                        title: 'swal2-title',
                        content: 'swal2-content',
                        confirmButton: 'boton'
                    }
                });
            } else {
                Swal.fire({
                    title: "Error",
                    text: data.message,
                    icon: "error",
                    customClass: {
                        popup: 'swal2-popup',
                        title: 'swal2-title',
                        content: 'swal2-content',
                        confirmButton: 'boton'
                    }
                });
            }
        })
        .catch(error => {
            console.error("Error:", error);
            Swal.fire({
                title: "Error",
                text: "Hubo un problema en el envío.",
                icon: "error",
                customClass: {
                    popup: 'swal2-popup',
                    title: 'swal2-title',
                    content: 'swal2-content',
                    confirmButton: 'boton'
                }
            });
        });
    }
</script>


<!-- Script para manejar el envío del formulario con fetch y mostrar popups -->
<script>
document.getElementById('loginForm').addEventListener('submit', function (e) {
    e.preventDefault(); // Evita envío tradicional

    const formData = new FormData(this);

    fetch('@Url.Action("Login", "General")', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.changePassword) {
                Swal.fire({
                    icon: 'info',
                    title: 'Actualizar contraseña',
                    text: data.message,
                    confirmButtonText: 'Continuar',
                    customClass: {
                        popup: 'swal2-popup',
                        title: 'swal2-title',
                        content: 'swal2-content',
                        confirmButton: 'boton'
                    }
                }).then(() => {
                    window.location.href = '@Url.Action("CambiarContraseña", "General")';
                });
            } else if (data.redirectUrl) {
                Swal.fire({
                    icon: 'success',
                    title: 'Inicio de sesión exitoso',
                    text: data.message,
                    showConfirmButton: false,
                    timer: 1500, // 1.5 segundos
                    customClass: {
                        popup: 'swal2-popup',
                        title: 'swal2-title',
                        content: 'swal2-content',
                        confirmButton: 'boton'
                    }
                }).then(() => {
                    window.location.href = data.redirectUrl;
                });
            }
        } else {
            // Mostrar error con SweetAlert
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.message,
                confirmButtonText: 'Intentar de nuevo',
                customClass: {
                    popup: 'swal2-popup',
                    title: 'swal2-title',
                    text: 'swal2-text',
                    content: 'swal2-content',
                    confirmButton: 'boton'

                }
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Ocurrió un error inesperado. Intenta de nuevo más tarde.',
            confirmButtonText: 'Aceptar',
            customClass: {
                popup: 'swal2-popup',
                title: 'swal2-title',
                content: 'swal2-content',
                icon: 'swal2-icon',
                 confirmButton: 'boton'
            }
        });
    });
});
</script>

<style>
    body {
        background-image: url('/Imagenes/fondo_login.png');
        background-size: cover;
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-position: center;
    }

    .titulo {
        margin-top: -20px;
        margin-bottom: 40px;
        font-size: 2.1em;
    }

    label {
        font-size: 1.1em;
        font-weight: 700;
    }

    .contenedor {
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 110px;
        margin: auto;
    }

    .loginForm {
    }

    .cont {
        height: 430px;
        width: 700px;
        margin-top: 0;
        margin-left: 150px;
        flex-direction: column;
    }

    /* Estilo para el mensaje de alerta centrado */
    .mensaje {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #f8d7da;
        color: #721c24;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        font-size: 1.2em;
        z-index: 9999;
    }

        .mensaje h2 {
            margin: 0;
            font-size: 1.8em;
            font-weight: bold;
        }

        .mensaje p {
            margin: 10px 0 0 0;
        }

    .boton {
        font-size: 1em;
        margin-top: 0;
        color: #2f2f2f;
        text-shadow: none;
        background-color: #d9a86c;
    }
    .botonOlv {
        margin-top: -20px;
        background: none;
        border: none;
        box-shadow: none;
        font-weight: 500;
    }
    .botonOlv:hover{
        color:white;       
        box-shadow:none;
        background:none;
    }
    .cajaEnlace {
        margin-top: 15px;
        text-align: center;
    }

    .enlace {
        text-align: center;
    }

        .enlace:hover {
            color: white;
        }

    .enlaceReg {
        text-decoration: underline;
    }

    .cajaBoton {
        margin-top: 5px;
        text-align:center;
    }
</style>


